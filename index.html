<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SaborPro Elite V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg: #f0f2f5; --primary: #1e293b; --accent: #f59e0b; 
            --success: #10b981; --danger: #ef4444; --white: #ffffff; 
            --shadow: 0 15px 25px rgba(0, 0, 0, 0.1);
        }

        body { font-family: 'Poppins', sans-serif; margin: 0; background-color: var(--bg); color: #1e293b; -webkit-tap-highlight-color: transparent; }

        .dark-screen {
            height: 100vh; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: radial-gradient(circle at top right, #1e293b, #0f172a);
        }
        .role-card { 
            background: rgba(255,255,255,0.1); padding: 40px; width: 85%; max-width: 320px; 
            border-radius: 35px; cursor: pointer; border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s; color: white; text-align: center; margin-bottom: 20px;
            font-size: 1.8rem; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .role-card:active { transform: scale(0.95); background: var(--white); color: var(--primary); }

        .login-card { background: var(--white); padding: 40px; border-radius: 35px; width: 85%; max-width: 350px; text-align: center; }

        .app-container { display: none; padding: 15px; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
        .card { background: white; border-radius: 25px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; }

        .total-box { background: linear-gradient(135deg, #1e293b, #334155); color: white; padding: 30px; border-radius: 30px; text-align: center; margin-bottom: 20px; }
        .total-amount { font-size: 3.5rem; font-weight: 600; color: var(--accent); }

        .search-bar { width: 100%; padding: 15px; border-radius: 15px; border: 2px solid #e2e8f0; font-size: 1rem; margin-bottom: 10px; box-sizing: border-box; }
        .cat-title { font-size: 1.1rem; font-weight: 600; margin: 20px 0 10px; color: var(--primary); border-left: 5px solid var(--accent); padding-left: 10px; text-transform: uppercase; }
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .item-card { background: white; border: 1px solid #eee; padding: 15px; border-radius: 20px; text-align: center; position: relative; }
        .item-card.agotado { border: 2px solid var(--danger); background: #fff5f5; }

        .btn-action { width: 100%; padding: 18px; border: none; border-radius: 18px; cursor: pointer; font-weight: 600; font-size: 1.1rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-entregar { background: var(--success); color: white; padding: 12px 20px; border-radius: 15px; border: none; font-weight: 600; }
        
        .admin-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
        .btn-tool { width: 35px; height: 35px; border-radius: 10px; border: none; margin-left: 5px; font-size: 1rem; }
        
        .hist-item { padding: 15px; border-bottom: 1px solid #eee; }
        .hist-meta { font-size: 0.8rem; color: var(--accent); font-weight: 600; }
        .hist-main { display: flex; justify-content: space-between; font-weight: 600; font-size: 1.1rem; margin: 3px 0; }
        .hist-details { font-size: 0.9rem; color: #64748b; line-height: 1.4; }

        /* CONTROLES ARREGLADOS */
        .qty-controls { display: flex; align-items: center; justify-content: center; gap: 5px; margin: 12px 0; background: #f8fafc; padding: 8px; border-radius: 15px; border: 1px solid #e2e8f0; }
        .qty-btn { background: var(--primary); color: white; border: none; width: 35px; height: 35px; border-radius: 10px; font-weight: bold; font-size: 1.3rem; }
        .qty-input { width: 50px; text-align: center; border: 1px solid #cbd5e1; border-radius: 8px; font-weight: 600; font-size: 1.1rem; background: white; color: var(--primary); padding: 4px 0; }

        input, select { width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 15px; box-sizing: border-box; font-family: inherit; }
    </style>
</head>
<body>

    <div id="role-selector" class="dark-screen">
        <h1 style="color:white; margin-bottom:40px; letter-spacing: 2px;">SABORPRO ELITE</h1>
        <div class="role-card" onclick="checkAuth('jefe')">üíº JEFE</div>
        <div class="role-card" onclick="openApp('mesero')">üèÉ MESERO</div>
        <div class="role-card" onclick="openApp('cocinero')">üç≥ COCINA</div>
    </div>

    <div id="login-screen" class="dark-screen" style="display:none">
        <div class="login-card">
            <h2 style="margin-bottom:20px">Acceso Privado</h2>
            <input type="email" id="email" placeholder="Correo electr√≥nico">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button class="btn-action btn-primary" onclick="login()">ENTRAR</button>
            <button onclick="location.reload()" style="background:none; border:none; color:#888; margin-top:20px">‚Üê VOLVER</button>
        </div>
    </div>

    <div id="main-app" class="app-container">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px">
            <h2 id="title" style="margin:0; font-weight: 600;">PANEL</h2>
            <button onclick="location.reload()" style="background:var(--danger); color:white; border:none; padding:10px 20px; border-radius:15px; font-weight: 600;">SALIR</button>
        </header>

        <div id="panel-jefe" style="display:none">
            <div class="total-box">
                <small style="opacity: 0.8; letter-spacing: 1px;">TOTAL CAJA HOY</small>
                <div id="total-caja" class="total-amount">Q0.00</div>
                <button onclick="reiniciarCaja()" style="background:none; color:white; border:1px solid rgba(255,255,255,0.4); padding:8px 15px; border-radius:12px; margin-top:10px">Reiniciar Caja</button>
            </div>
            <div class="card">
                <h3>üìã Historial de Ventas</h3>
                <div id="historial-ventas"></div>
            </div>
            <div class="card">
                <h3>üç¥ Gestionar Men√∫</h3>
                <input type="text" id="n" placeholder="Nombre del plato">
                <input type="number" id="p" placeholder="Precio Q">
                <select id="c"><option>Comidas</option><option>Bebidas</option><option>Postres</option></select>
                <button class="btn-action btn-primary" onclick="addMenu()">+ AGREGAR PRODUCTO</button>
                <div id="admin-menu-list" style="margin-top:20px"></div>
            </div>
        </div>

        <div id="panel-mesero" style="display:none">
            <div id="notificaciones"></div>
            <input type="text" id="searchMenu" class="search-bar" placeholder="üîç Buscar plato..." onkeyup="updateUI()">
            <div class="card" style="padding: 15px;">
                <b>Mesa #:</b> <input type="number" id="mesa" style="width:80px; margin:0; padding:10px; display:inline-block">
            </div>
            <div id="mesero-menu-display"></div>
            <div class="card" style="border-top: 10px solid var(--success)">
                <h3>üõí Pedido</h3>
                <div id="cart-list" style="margin-bottom:15px"></div>
                <button class="btn-action btn-success" onclick="sendToKitchen()">ENVIAR A COCINA</button>
            </div>
        </div>

        <div id="panel-cocinero" style="display:none">
            <div id="kitchen-display"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBjwKWqke_cuUL885eHSv1TNwnFGyamO2s",
        authDomain: "comedorv1.firebaseapp.com",
        databaseURL: "https://comedorv1-default-rtdb.firebaseio.com",
        projectId: "comedorv1",
        storageBucket: "comedorv1.firebasestorage.app",
        messagingSenderId: "625581498462",
        appId: "1:625581498462:web:745400c406ba0bde3c14cf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let userPath = "", db_menu = [], pedidos = [], ventas = [], cart = [];

    auth.onAuthStateChanged(user => {
        if(user) { 
            userPath = `usuarios/${user.uid}/`; 
            localStorage.setItem('lastUID', user.uid);
            iniciarApp(); 
        } else {
            const id = localStorage.getItem('lastUID');
            if(id) { userPath = `usuarios/${id}/`; iniciarApp(); }
        }
    });

    function iniciarApp() {
        if(!userPath) return;
        db.ref(userPath + 'menu').on('value', s => { db_menu = s.val() || []; updateUI(); });
        db.ref(userPath + 'pedidos').on('value', s => { pedidos = s.val() || []; updateUI(); });
        db.ref(userPath + 'ventas').on('value', s => { ventas = s.val() || []; updateUI(); });
    }

    function checkAuth(r) {
        if(auth.currentUser) openApp(r);
        else { document.getElementById('role-selector').style.display='none'; document.getElementById('login-screen').style.display='flex'; }
    }

    async function login() {
        const e = document.getElementById('email').value, p = document.getElementById('pass').value;
        try { await auth.signInWithEmailAndPassword(e, p).catch(() => auth.createUserWithEmailAndPassword(e, p)); openApp('jefe'); } catch(err) { alert("Error"); }
    }

    function openApp(r) {
        document.getElementById('role-selector').style.display='none';
        document.getElementById('login-screen').style.display='none';
        document.getElementById('main-app').style.display='block';
        document.querySelectorAll('[id^="panel-"]').forEach(p => p.style.display='none');
        document.getElementById('panel-'+r).style.display='block';
        document.getElementById('title').innerText = r.toUpperCase();
        updateUI();
    }

    function updateUI() {
        const totalVentas = ventas.reduce((acc, v) => acc + (v.total || 0), 0);
        if(document.getElementById('total-caja')) 
            document.getElementById('total-caja').innerText = "Q" + totalVentas.toLocaleString('en-US', {minimumFractionDigits: 2});

        const hist = document.getElementById('historial-ventas');
        if(hist) {
            hist.innerHTML = ventas.length ? ventas.map(v => `
                <div class="hist-item">
                    <div class="hist-meta">üïí ${v.hora || '--:--'}</div>
                    <div class="hist-main"><span>Mesa #${v.mesa}</span><span style="color:var(--success)">Q${v.total.toFixed(2)}</span></div>
                    <div class="hist-details">${v.items.map(i => `<b>${i.qty}x</b> ${i.nombre}`).join(", ")}</div>
                </div>`).reverse().join("") : "<p>No hay ventas.</p>";
        }

        const adminList = document.getElementById('admin-menu-list');
        if(adminList) {
            adminList.innerHTML = db_menu.map(i => `
                <div class="admin-item">
                    <span><strong>${i.nombre}</strong><br><small>Q${i.precio.toFixed(2)}</small></span>
                    <div>
                        <button class="btn-tool" style="background:${i.disponible !== false ? 'var(--success)' : 'var(--danger)'}; color:white; width:auto; padding:0 8px; font-size:0.7rem" onclick="toggleStock('${i.id}')">
                            ${i.disponible !== false ? 'HAY' : 'NO'}
                        </button>
                        <button class="btn-tool" style="background:#eee" onclick="editProduct('${i.id}', '${i.nombre}', ${i.precio})">‚úèÔ∏è</button>
                        <button class="btn-tool" style="background:#ffebee; color:var(--danger)" onclick="deleteProduct('${i.id}')">üóëÔ∏è</button>
                    </div>
                </div>`).join("");
        }

        const meseroDiv = document.getElementById('mesero-menu-display');
        const search = document.getElementById('searchMenu')?.value.toLowerCase() || "";
        if(meseroDiv) {
            const cats = ["Comidas", "Bebidas", "Postres"];
            meseroDiv.innerHTML = cats.map(cat => {
                const items = db_menu.filter(i => i.categoria === cat && i.nombre.toLowerCase().includes(search));
                if(!items.length) return "";
                return `<div class="cat-title">${cat}</div><div class="menu-grid">` + items.map(i => {
                    const isAgotado = i.disponible === false;
                    return `
                    <div class="item-card ${isAgotado ? 'agotado' : ''}">
                        <strong>${i.nombre}</strong><br><small>Q${i.precio}</small>
                        ${!isAgotado ? `
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="changeQty('qty-${i.id}', -1)">-</button>
                                <input type="number" id="qty-${i.id}" class="qty-input" value="1">
                                <button class="qty-btn" onclick="changeQty('qty-${i.id}', 1)">+</button>
                            </div>
                            <button class="btn-action btn-primary" style="padding:10px; font-size:0.9rem; border-radius:12px;" onclick="toCart('${i.id}','${i.nombre}',${i.precio})">AGREGAR</button>
                        ` : `<div style="color:var(--danger); font-weight:bold; margin-top:15px; font-size:0.8rem">AGOTADO</div>`}
                    </div>`;
                }).join("") + `</div>`;
            }).join("");
        }

        const kitch = document.getElementById('kitchen-display');
        if(kitch) kitch.innerHTML = pedidos.filter(p => p.estado === 'pendiente').map(p => `<div class="card"><h3>Mesa #${p.mesa}</h3>${p.items.map(i => `<div><b>${i.qty}x</b> ${i.nombre}</div>`).join("")}<button class="btn-action btn-success" style="margin-top:15px" onclick="marcarListo(${p.id})">LISTO ‚úÖ</button></div>`).join("");
        
        const notif = document.getElementById('notificaciones');
        if(notif) notif.innerHTML = pedidos.filter(p => p.estado === 'listo').map(p => `
            <div class="card" style="border:3px solid var(--success); display:flex; justify-content:space-between; align-items:center; padding:15px">
                <span>üîî Mesa #${p.mesa} LISTA</span>
                <button class="btn-entregar" onclick="entregar(${p.id})">ENTREGAR</button>
            </div>`).join("");
    }

    function changeQty(id, delta) {
        const inp = document.getElementById(id);
        if(!inp) return;
        let v = parseInt(inp.value) + delta;
        if(v < 1) v = 1;
        inp.value = v;
    }

    function toCart(id, n, p) {
        const inp = document.getElementById('qty-'+id);
        const qty = inp ? parseInt(inp.value) : 1;
        if(isNaN(qty) || qty < 1) return;
        const ex = cart.find(x => x.nombre === n);
        if(ex) ex.qty += qty; else cart.push({nombre:n, precio:p, qty});
        if(inp) inp.value = 1;
        document.getElementById('cart-list').innerHTML = cart.map(i => `<div style="padding:5px 0"><b>${i.qty}x</b> ${i.nombre}</div>`).join("");
    }

    function addMenu() {
        const n = document.getElementById('n').value, p = parseFloat(document.getElementById('p').value), c = document.getElementById('c').value;
        if(n && !isNaN(p)) {
            db_menu.push({id: String(Date.now()), nombre: n, precio: p, categoria: c, disponible: true});
            db.ref(userPath+'menu').set(db_menu);
            document.getElementById('n').value = ""; document.getElementById('p').value = "";
        }
    }

    function editProduct(id, oldN, oldP) {
        const newN = prompt("Nuevo nombre:", oldN);
        const newP = parseFloat(prompt("Nuevo precio:", oldP));
        if(newN && !isNaN(newP)) {
            const idx = db_menu.findIndex(i => String(i.id) === String(id));
            db_menu[idx].nombre = newN; db_menu[idx].precio = newP;
            db.ref(userPath+'menu').set(db_menu);
        }
    }

    function toggleStock(id) {
        const idx = db_menu.findIndex(i => String(i.id) === String(id));
        db_menu[idx].disponible = (db_menu[idx].disponible !== false) ? false : true;
        db.ref(userPath+'menu').set(db_menu);
    }

    function deleteProduct(id) {
        if(confirm("¬øEliminar?")) {
            db_menu = db_menu.filter(i => String(i.id) !== String(id));
            db.ref(userPath+'menu').set(db_menu);
        }
    }

    function sendToKitchen() {
        const m = document.getElementById('mesa').value;
        if(!m || !cart.length) return alert("Mesa o pedido vac√≠o");
        pedidos.push({id: Date.now(), mesa: m, items: [...cart], total: cart.reduce((a,b)=>a+(b.precio*b.qty),0), estado: 'pendiente'});
        db.ref(userPath+'pedidos').set(pedidos);
        cart = []; document.getElementById('cart-list').innerHTML=""; document.getElementById('mesa').value="";
    }

    function marcarListo(id) { 
        const i = pedidos.findIndex(x => x.id === id); 
        pedidos[i].estado = 'listo'; db.ref(userPath+'pedidos').set(pedidos); 
    }

    function entregar(id) {
        const i = pedidos.findIndex(x => x.id === id);
        const t = new Date();
        const hora = t.getHours() + ":" + (t.getMinutes() < 10 ? '0' : '') + t.getMinutes();
        const v = {...pedidos[i], hora: hora};
        ventas.push(v); pedidos.splice(i, 1);
        db.ref(userPath+'pedidos').set(pedidos); db.ref(userPath+'ventas').set(ventas);
    }

    function reiniciarCaja() { if(confirm("¬øReiniciar?")) db.ref(userPath+'ventas').set([]); }
</script>
</body>
</html>
    